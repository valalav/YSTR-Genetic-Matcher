# API Configuration Guide

## –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ API

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç **–ï–î–ò–ù–°–¢–í–ï–ù–ù–û –ü–†–ê–í–ò–õ–¨–ù–´–ô** —Å–ø–æ—Å–æ–± –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ API –≤ –ø—Ä–æ–µ–∫—Ç–µ DNA-utils-universal. –°–ª–µ–¥–æ–≤–∞–Ω–∏–µ —ç—Ç–∏–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ ftdna-haplo API.

---

## üî¥ –í–ê–ñ–ù–û: –î–≤–∞ —É—Ä–æ–≤–Ω—è –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è

–í –ø—Ä–æ–µ–∫—Ç–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è **–î–í–ê –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö –º–µ—Ö–∞–Ω–∏–∑–º–∞** –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è:

### 1. Next.js Rewrites (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç #1)
**–§–∞–π–ª:** `str-matcher/next.config.js`

Next.js **–ü–ï–†–í–´–ú** –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ `rewrites()`. –≠—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **–î–û** —Ç–æ–≥–æ, –∫–∞–∫ –∑–∞–ø—Ä–æ—Å –ø–æ–ø–∞–¥—ë—Ç –≤ API routes.

```javascript
async rewrites() {
  return [
    {
      source: '/api/:path*',
      destination: `${process.env.HAPLO_API_URL || 'http://localhost:9003'}/api/:path*`,
    },
  ]
}
```

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è `HAPLO_API_URL`
- ‚úÖ Fallback –Ω–∞ `http://localhost:9003` (–ë–ï–ó `/api` –Ω–∞ –∫–æ–Ω—Ü–µ!)
- ‚úÖ –î–æ–±–∞–≤–ª—è–µ—Ç `/api/:path*` –≤ destination
- ‚ùå **–ù–ï –ò–°–ü–û–õ–¨–ó–£–ô–¢–ï** –¥—Ä—É–≥–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (`BACKEND_API_URL`, `NEXT_PUBLIC_API_URL`)

### 2. API Route Handler (–†–µ–∑–µ—Ä–≤–Ω—ã–π, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ rewrites)
**–§–∞–π–ª:** `str-matcher/src/app/api/[...path]/route.ts`

–≠—Ç–æ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ rewrites –ù–ï —Å—Ä–∞–±–æ—Ç–∞–ª–∏.

```typescript
const BACKEND_API_URL = process.env.BACKEND_API_URL || 'http://127.0.0.1:9003/api'
```

**–í –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –ù–ï –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è**, —Ç–∞–∫ –∫–∞–∫ Next.js rewrites –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—é—Ç –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–Ω—å—à–µ.

---

## üéØ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ—Ä—Ç–æ–≤

### Development mode (npm run dev)

```
ftdna-haplo:  http://localhost:9003
str-matcher:  http://localhost:3000
```

**–ù–µ —Ç—Ä–µ–±—É—é—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è** - —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ fallback –∑–Ω–∞—á–µ–Ω–∏—è—Ö.

**–§–∞–π–ª `.env.local` –ù–ï –ù–£–ñ–ï–ù** –∏ **–ù–ï –î–û–õ–ñ–ï–ù –°–£–©–ï–°–¢–í–û–í–ê–¢–¨** –≤ `str-matcher/`!

### Production mode (PM2)

```
ftdna-haplo:  http://localhost:9003
str-matcher:  http://localhost:9002
```

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:** `ecosystem.config.js`

```javascript
{
  name: "ftdna-haplo-app",
  env_production: {
    PORT: 9003,  // ‚Üê –í–∞–∂–Ω–æ: 9003, –Ω–µ 9004!
  }
},
{
  name: "str-matcher-app",
  env_production: {
    HAPLO_API_URL: "http://localhost:9003"  // ‚Üê –ë–µ–∑ /api –Ω–∞ –∫–æ–Ω—Ü–µ!
  }
}
```

---

## ‚ùå –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏ (—á–µ–≥–æ –ù–ï –¥–µ–ª–∞—Ç—å)

### –û—à–∏–±–∫–∞ #1: –°–æ–∑–¥–∞–Ω–∏–µ `.env.local` —Ñ–∞–π–ª–∞
```bash
# ‚ùå –ù–ï –°–û–ó–î–ê–í–ê–ô–¢–ï —ç—Ç–æ—Ç —Ñ–∞–π–ª:
str-matcher/.env.local
```

**–ü–æ—á–µ–º—É:** Next.js –∫–µ—à–∏—Ä—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ. –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `.env.local` —Ç—Ä–µ–±—É—é—Ç –ø–æ–ª–Ω–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –õ—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å fallback –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∫–æ–¥–µ.

### –û—à–∏–±–∫–∞ #2: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
```javascript
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
process.env.BACKEND_API_URL
process.env.NEXT_PUBLIC_API_URL

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
process.env.HAPLO_API_URL
```

### –û—à–∏–±–∫–∞ #3: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—Ç
```javascript
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
'http://localhost:9004'

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
'http://localhost:9003'
```

### –û—à–∏–±–∫–∞ #4: –õ–∏—à–Ω–∏–π /api –≤ fallback
```javascript
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (–≤ next.config.js):
destination: `${process.env.HAPLO_API_URL || 'http://localhost:9003/api'}/:path*`
//                                                                    ^^^^ –ª–∏—à–Ω–µ–µ!

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
destination: `${process.env.HAPLO_API_URL || 'http://localhost:9003'}/api/:path*`
//                                                                   ^^^^^^^^^^^^ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∑–¥–µ—Å—å
```

---

## üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: "500 Internal Server Error" –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–∞—Ö –∫ /api/haplogroup-path/*

**–®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ ftdna-haplo API –Ω–∞–ø—Ä—è–º—É—é**
```bash
curl http://localhost:9003/api/haplogroup-path/C-Y4541
```

–ï—Å–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON —Å –¥–∞–Ω–Ω—ã–º–∏ ‚Üí ftdna-haplo —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ

**–®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Next.js**

–ò—â–∏—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª–∏:
```
Failed to proxy http://localhost:9004/api/...
```

–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –ø–æ—Ä—Ç **9004** –≤–º–µ—Å—Ç–æ **9003** ‚Üí –ø—Ä–æ–±–ª–µ–º–∞ –≤ `next.config.js`

**–®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ next.config.js**
```bash
grep -A3 "rewrites" str-matcher/next.config.js
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```javascript
destination: `${process.env.HAPLO_API_URL || 'http://localhost:9003'}/api/:path*`
```

**–®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ .env.local**
```bash
ls -la str-matcher/.env.local
# –î–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏: No such file or directory
```

**–®–∞–≥ 5: –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫**
```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ npm run dev (Ctrl+C)
# –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å—ã —É–±–∏—Ç—ã:
netstat -ano | findstr :3000
netstat -ano | findstr :9003

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∑–∞–Ω–æ–≤–æ:
npm run dev
```

---

## üìã Checklist –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º

- [ ] –£–¥–∞–ª—ë–Ω —Ñ–∞–π–ª `str-matcher/.env.local`
- [ ] –í `next.config.js` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `HAPLO_API_URL`
- [ ] Fallback –≤ `next.config.js` —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç `9003`
- [ ] –í `ecosystem.config.js` ftdna-haplo –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ—Ä—Ç `9003`
- [ ] –í `ecosystem.config.js` str-matcher –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `HAPLO_API_URL`
- [ ] ftdna-haplo –∑–∞–ø—É—â–µ–Ω –∏ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ `http://localhost:9003/api/`

---

## üéì –ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —Ç–∞–∫?

### –ü–æ—á–µ–º—É rewrites, –∞ –Ω–µ API route?
Next.js rewrites —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ HTTP —Å–µ—Ä–≤–µ—Ä–∞, —á—Ç–æ –±—ã—Å—Ç—Ä–µ–µ –∏ –Ω–∞–¥—ë–∂–Ω–µ–µ, —á–µ–º –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ JavaScript –∫–æ–¥.

### –ü–æ—á–µ–º—É –±–µ–∑ /api –≤ fallback?
–í rewrites –º—ã –¥–æ–±–∞–≤–ª—è–µ–º `/api/:path*` –≤ –∫–æ–Ω—Ü–µ destination. –ï—Å–ª–∏ –≤ fallback —É–∂–µ –µ—Å—Ç—å `/api`, –ø–æ–ª—É—á–∏—Ç—Å—è –¥–≤–æ–π–Ω–æ–π –ø—É—Ç—å `/api/api/...`

### –ü–æ—á–µ–º—É –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å .env.local?
Next.js –∫–µ—à–∏—Ä—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –≤ production build. –í dev mode —Ç–æ–∂–µ –≤–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å –≥–æ—Ä—è—á–µ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π. Fallback –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∫–æ–¥–µ –±–æ–ª–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã.

### –ü–æ—á–µ–º—É –ø–æ—Ä—Ç 9003, –∞ –Ω–µ 9004?
–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏ ftdna-haplo —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 9003 –≤ dev mode. –ü–æ—Ä—Ç 9004 –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –≤ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä–∞—è –±–æ–ª—å—à–µ –Ω–µ –∞–∫—Ç—É–∞–ª—å–Ω–∞.

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `str-matcher/next.config.js` - –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è rewrites
- `str-matcher/src/app/api/[...path]/route.ts` - –†–µ–∑–µ—Ä–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- `ecosystem.config.js` - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è production (PM2)
- `package.json` - –°–∫—Ä–∏–ø—Ç—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞ dev mode
- `ftdna_haplo/server/server.js` - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ftdna-haplo —Å–µ—Ä–≤–µ—Ä–∞

---

## üìù –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

**2025-10-04:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ next.config.js
- –ò–∑–º–µ–Ω—ë–Ω –ø–æ—Ä—Ç —Å 9004 –Ω–∞ 9003
- –ò–∑–º–µ–Ω–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è —Å `NEXT_PUBLIC_API_URL` –Ω–∞ `HAPLO_API_URL`
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –ø—É—Ç—å –≤ destination (—É–±—Ä–∞–Ω `/api` –∏–∑ fallback)
- –£–¥–∞–ª—ë–Ω `.env.local` —Ñ–∞–π–ª
- –û–±–Ω–æ–≤–ª—ë–Ω `ecosystem.config.js` –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –ø—Ä–æ–¥–∞–∫—à–Ω –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
