# ftdna_haplo: Структура и принципы работы

## Общее описание

`ftdna_haplo` - это бэкенд-сервис, входящий в состав проекта DNA-utils-universal, предназначенный для обработки и анализа данных о гаплогруппах Y-хромосомы из двух основных источников: Family Tree DNA (FTDNA) и YFull. Сервис обеспечивает унифицированный доступ к филогенетическим деревьям Y-ДНК, поиск по SNP-маркерам и гаплогруппам, а также предоставляет дополнительные аналитические возможности.

## Архитектура проекта

Проект `ftdna_haplo` имеет клиент-серверную архитектуру:

### Серверная часть
Построена на Node.js с использованием Express.js для API-сервера:
- **Адрес**: По умолчанию запускается на порту 9003
- **API-маршруты**: Доступны по базовому пути `/api`

### Клиентская часть
Веб-интерфейс разработан с использованием React и Vite:
- **Основные технологии**: React, Tailwind CSS
- **Инструменты сборки**: Vite
- **Состояние**: Управляется с помощью React Hooks

## Ключевые файлы и их функции

### Серверные компоненты

#### 1. server.js
**Функция**: Основной файл сервера, запускающий Express-приложение и определяющий API-маршруты.
**Ключевые возможности**:
- Инициализация деревьев FTDNA и YFull
- Настройка CORS и middleware
- Определение маршрутов API для поиска, проверки субкладов и автодополнения

#### 2. haplo_functions.js
**Функция**: Основной класс для работы с деревом гаплогрупп FTDNA.
**Ключевые возможности**:
- Парсинг и индексация данных FTDNA
- Поиск гаплогрупп по имени или SNP
- Получение детальной информации о гаплогруппе
- Построение дерева, анализ путей гаплогрупп
- Проверка принадлежности гаплогруппы к субкладам

#### 3. yfull_adapter.js
**Функция**: Адаптер для работы с деревом гаплогрупп YFull.
**Ключевые возможности**:
- Преобразование формата данных YFull в формат, совместимый с FTDNA
- Индексация и поиск SNP-маркеров
- Получение детализированной информации о гаплогруппах
- Сопоставление гаплогрупп между YFull и FTDNA

#### 4. yfull_tree.js
**Функция**: Класс для обработки и индексации данных из YFull.
**Ключевые возможности**:
- Построение индексов для быстрого поиска
- Форматирование SNP-маркеров
- Получение путей в филогенетическом дереве
- Статистический анализ дерева

#### 5. search_integration.js
**Функция**: Интегратор для поиска соответствий между деревьями FTDNA и YFull.
**Ключевые возможности**:
- Поиск соответствующих ветвей между разными деревьями
- Сопоставление SNP-маркеров и гаплогрупп
- Оценка достоверности сопоставления

#### 6. haplogroup-service.js
**Функция**: Сервисный класс, объединяющий функциональность разных деревьев.
**Ключевые возможности**:
- Унифицированный поиск по обоим деревьям
- Проверка субкладов с поддержкой разных алгоритмов
- Интеграция результатов из разных источников

### Клиентские компоненты

#### 1. HaploViewer.jsx
**Функция**: Основной компонент пользовательского интерфейса для поиска и просмотра гаплогрупп.
**Ключевые возможности**:
- Поисковая форма с автодополнением
- Отображение путей гаплогрупп
- Показ статистики и вариантов SNP
- Просмотр географического распределения
- Визуализация дерева гаплогрупп

#### 2. HaploFilters.jsx
**Функция**: Компонент для фильтрации результатов поиска.
**Ключевые возможности**:
- Фильтрация по странам
- Фильтрация по количеству тестов
- Настройка параметров поиска

#### 3. HaploCharts.jsx и HaplogroupTree.jsx
**Функция**: Компоненты для визуализации деревьев гаплогрупп.
**Ключевые возможности**:
- Интерактивное отображение дерева
- Визуализация связей между гаплогруппами
- Масштабирование и навигация по дереву

## Алгоритмы и процессы

### 1. Загрузка и индексация данных
1. При запуске сервера загружаются JSON-файлы с данными FTDNA и YFull
2. Создаются индексы для быстрого поиска:
   - Маппинг SNP → ID гаплогруппы
   - Маппинг имени гаплогруппы → ID гаплогруппы
3. Форматируются специальные данные (SNP, статистика и др.)

### 2. Процесс поиска гаплогруппы
1. Пользователь вводит запрос (SNP или название гаплогруппы)
2. Сервер выполняет поиск в обоих деревьях (FTDNA и YFull)
3. Если найдено только в одном источнике, система пытается найти соответствие во втором
4. Результаты объединяются и возвращаются клиенту в унифицированном формате

### 3. Проверка субкладов
1. Система получает две гаплогруппы для сравнения
2. Выполняется проверка базовых гаплогрупп (одинаковый корень)
3. Извлекаются и сравниваются пути в дереве для обеих гаплогрупп
4. В зависимости от режима (showNonNegative) выполняется один из алгоритмов:
   - Точное включение в путь
   - Проверка, является ли одна гаплогруппа предком другой

### 4. Поиск соответствий между деревьями
1. Система находит исходный узел в одном из деревьев
2. Извлекает путь и основные SNP-маркеры
3. Последовательно проверяет маркеры в целевом дереве
4. Вычисляет достоверность сопоставления на основе количества совпавших SNP

## Структура данных

### 1. Формат данных FTDNA
Ключевые поля:
- `haplogroupId`: Уникальный идентификатор
- `name`: Название гаплогруппы
- `variants`: Массив SNP-маркеров
- `kitsCount`: Количество тестов
- `children`: Массив дочерних гаплогрупп
- `countryCounts`: Статистика по странам

### 2. Формат данных YFull
Ключевые поля:
- `id`: Уникальный идентификатор
- `snps`: Строка с SNP-маркерами
- `formed`: Время формирования (лет назад)
- `tmrca`: Время до наиболее недавнего общего предка
- `children`: Массив дочерних гаплогрупп

### 3. Унифицированный формат ответа API
```json
{
  "name": "R-M269",
  "ftdnaDetails": {
    "path": {
      "nodes": [...],
      "string": "A > B > ... > R-M269"
    },
    "statistics": {...},
    "treeData": {...}
  },
  "yfullDetails": {
    "path": {...},
    "statistics": {...}
  }
}
```

## Интеграция с другими компонентами DNA-utils-universal

### 1. Интеграция с str-matcher
- `ftdna_haplo` предоставляет API для проверки совпадений гаплогрупп
- Предоставляет данные о путях и субкладах для фильтрации результатов STR-маркеров
- Обеспечивает дополнительную информацию для визуализации в MatchesTable

### 2. Интеграция с ystr_predictor
- Обеспечивает актуальную структуру дерева гаплогрупп для модели машинного обучения
- Помогает в валидации предсказанных гаплогрупп
- Предоставляет дополнительную информацию о предсказанных гаплогруппах

## Функциональные возможности API

### 1. /api/search/:haplogroup
**Назначение**: Поиск гаплогруппы по имени или SNP
**Возвращает**: Подробную информацию из FTDNA и YFull

### 2. /api/haplogroup-path/:haplogroup
**Назначение**: Получение полного пути гаплогруппы в дереве
**Возвращает**: Узлы пути с их именами и SNP-маркерами

### 3. /api/check-subclade
**Назначение**: Проверка, является ли одна гаплогруппа субкладом другой
**Параметры**: haplogroup, parentHaplogroup, showNonNegative
**Возвращает**: Boolean результат проверки

### 4. /api/autocomplete
**Назначение**: Автодополнение при вводе названия гаплогруппы или SNP
**Параметры**: term (текст для поиска)
**Возвращает**: Массив совпадений с указанием источника (FTDNA/YFull)

## Алгоритмы обработки деревьев

### 1. Построение поддерева
Рекурсивный алгоритм, который строит объект дерева начиная с указанного узла:
1. Создается узел с основной информацией
2. Для каждого дочернего узла рекурсивно вызывается та же функция
3. Результаты объединяются в единое дерево
4. Опционально выполняется сортировка узлов (например, по количеству тестов)

### 2. Поиск общего предка
Алгоритм для нахождения общего предка двух гаплогрупп:
1. Получаются цепочки предков для обеих гаплогрупп
2. Цепочки сравниваются для поиска первого общего узла
3. Вычисляется "глубина расхождения" - сколько узлов от общего предка до каждой гаплогруппы

### 3. Региональная статистика
Алгоритм для анализа распространения гаплогрупп по регионам:
1. Определяются регионы и страны, входящие в них
2. Для каждой гаплогруппы собирается статистика по странам
3. Данные агрегируются по регионам
4. Вычисляются доминирующие гаплогруппы для каждого региона

## Техническая реализация

### 1. Кэширование данных
- Использование Map для быстрого поиска
- Кэширование преобразованных узлов YFull → FTDNA
- История поисковых запросов на клиенте (localStorage)

### 2. Обработка ошибок
- Полная цепочка обработки ошибок от клиента до сервера
- Информативные сообщения об ошибках с кодами статусов HTTP
- Визуальное отображение ошибок на клиенте

### 3. Оптимизации
- Индексация данных для быстрого поиска
- Отложенная загрузка данных (lazy loading)
- Предотвращение избыточных запросов с помощью debounce

## Заключение

Компонент `ftdna_haplo` является ключевым элементом в экосистеме DNA-utils-universal, обеспечивая унифицированный доступ к данным Y-ДНК филогении из разных источников. Благодаря продуманной архитектуре и эффективным алгоритмам, он позволяет быстро находить информацию о гаплогруппах, визуализировать генеалогические деревья и выполнять сравнительный анализ данных из различных баз данных ДНК-генеалогии.
