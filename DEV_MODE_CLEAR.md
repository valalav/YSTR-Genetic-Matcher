# Очистка базы данных при разработке

## 🎯 Решение проблемы

### Проблема
После перезапуска dev-сервера (`npm run dev`) данные оставались в IndexedDB браузера, загружалось 3055 профилей автоматически. Это неудобно при разработке - нужна чистая база при каждом запуске.

### Решение
Добавлена **автоматическая очистка IndexedDB** в dev-режиме при каждой перезагрузке страницы.

---

## ✅ Что исправлено

### 1. Автоматическая очистка в dev-режиме

**Файл**: `str-matcher/src/hooks/useSTRMatcher.ts`

```typescript
useEffect(() => {
  const loadProfilesFromIndexedDB = async () => {
    await dbManager.init();
    console.log('✅ IndexedDB инициализирована');

    // 🗑️ ОЧИСТКА ПРИ DEV РЕЖИМЕ
    if (process.env.NODE_ENV === 'development') {
      await dbManager.clearProfiles();
      console.log('🗑️ IndexedDB очищена (dev режим)');
      setDatabase([]);
      return; // База пустая, не загружаем
    }

    // В production режиме - загружаем данные как обычно
    // ...
  };
}, []);
```

### 2. Защита от двойной инициализации

**Проблема**: React Strict Mode в dev-режиме вызывает `useEffect` **2 раза**

**Решение**: Добавлена защита через cleanup функцию:

```typescript
useEffect(() => {
  let cancelled = false; // Флаг отмены

  const loadProfilesFromIndexedDB = async () => {
    if (cancelled) return; // Пропускаем повторный вызов

    // ... инициализация

    if (!cancelled) {
      setDatabase(profiles); // Устанавливаем только если не отменено
    }
  };

  loadProfilesFromIndexedDB();

  // Cleanup - отменяет повторный вызов
  return () => {
    cancelled = true;
  };
}, []);
```

---

## 📊 Как это работает

### Development режим (npm run dev):

```
┌────────────────────────────────┐
│  Пользователь открывает страницу │
└───────────────┬────────────────┘
                │
                ▼
┌────────────────────────────────┐
│  useEffect() запускается        │
│  (может быть 2 раза в Strict)   │
└───────────────┬────────────────┘
                │
                ▼
┌────────────────────────────────┐
│  dbManager.init()              │
│  ✅ Инициализация             │
└───────────────┬────────────────┘
                │
                ▼
┌────────────────────────────────┐
│  Проверка NODE_ENV             │
│  === 'development' ✅          │
└───────────────┬────────────────┘
                │
                ▼
┌────────────────────────────────┐
│  🗑️ dbManager.clearProfiles() │
│  Очистка всех данных           │
└───────────────┬────────────────┘
                │
                ▼
┌────────────────────────────────┐
│  setDatabase([])               │
│  📭 База пустая                │
└────────────────────────────────┘
```

### Production режим (npm run build):

```
┌────────────────────────────────┐
│  useEffect() запускается        │
└───────────────┬────────────────┘
                │
                ▼
┌────────────────────────────────┐
│  dbManager.init()              │
└───────────────┬────────────────┘
                │
                ▼
┌────────────────────────────────┐
│  Проверка NODE_ENV             │
│  === 'production' ✅           │
└───────────────┬────────────────┘
                │
                ▼
┌────────────────────────────────┐
│  ⏭️ Пропускаем очистку         │
└───────────────┬────────────────┘
                │
                ▼
┌────────────────────────────────┐
│  getProfiles()                 │
│  📦 Загружаем сохраненные данные│
└────────────────────────────────┘
```

---

## 🧪 Тестирование

### Проверка в Development:

1. **Запусти dev-сервер**:
   ```bash
   npm run dev
   ```

2. **Открой http://localhost:3001**

3. **Проверь консоль**:
   ```
   📂 Инициализируем IndexedDB...
   ✅ IndexedDB инициализирована
   🗑️ IndexedDB очищена (dev режим) - при каждом запуске база пустая
   ```

4. **Импортируй CSV** (100 профилей)

5. **Перезагрузи страницу (F5)**

6. **Проверь консоль**:
   ```
   📂 Инициализируем IndexedDB...
   ✅ IndexedDB инициализирована
   🗑️ IndexedDB очищена (dev режим)
   ```
   ✅ **База снова пустая!**

### Проверка в Production:

1. **Собери production версию**:
   ```bash
   npm run build
   npm start
   ```

2. **Импортируй данные**

3. **Перезагрузи страницу**

4. **Проверь консоль**:
   ```
   📂 Инициализируем IndexedDB...
   ✅ IndexedDB инициализирована
   📂 Найдено 100 профилей в IndexedDB, загружаем...
   ✅ Загружено 100 профилей
   ```
   ✅ **Данные сохранились!**

---

## ⚙️ Переключение режима

### Отключить автоочистку в dev (если нужно):

Закомментируй блок очистки в `useSTRMatcher.ts`:

```typescript
// 🗑️ ОЧИСТКА ПРИ DEV РЕЖИМЕ
if (process.env.NODE_ENV === 'development') {
  // await dbManager.clearProfiles();
  // console.log('🗑️ IndexedDB очищена (dev режим)');
  // setDatabase([]);
  // return;
}
```

### Включить автоочистку в production (не рекомендуется!):

```typescript
// ОСТОРОЖНО: Очистка в production - данные будут теряться!
if (true) { // Всегда очищать
  await dbManager.clearProfiles();
  setDatabase([]);
  return;
}
```

---

## 📝 Логи для отладки

### Нормальные логи (dev режим):

```
📂 Инициализируем IndexedDB...
✅ IndexedDB инициализирована
🗑️ IndexedDB очищена (dev режим) - при каждом запуске база пустая
```

### После импорта:

```
✅ Успешно обработано 100 профилей
🔄 База обновлена в памяти: было 0, добавлено 100, стало 100
💾 Данные сохранены в IndexedDB
```

### После F5 (снова очищено):

```
📂 Инициализируем IndexedDB...
✅ IndexedDB инициализирована
🗑️ IndexedDB очищена (dev режим) - при каждом запуске база пустая
```

### ❌ Неправильные логи (двойная инициализация):

```
📂 Инициализируем IndexedDB...
📂 Инициализируем IndexedDB...    ← НЕ ДОЛЖНО БЫТЬ!
✅ IndexedDB инициализирована
✅ IndexedDB инициализирована      ← НЕ ДОЛЖНО БЫТЬ!
```

Если видишь двойные логи - проблема в React Strict Mode, но наша защита через `cancelled` флаг должна это предотвратить.

---

## 🔧 Ручная очистка через DevTools

Если нужно очистить базу вручную:

1. **F12** → Открыть DevTools
2. **Application** → IndexedDB
3. **str_matcher_db** → Правый клик → **Delete database**
4. **F5** → Перезагрузить страницу

Или через консоль:

```javascript
// Удалить базу полностью
indexedDB.deleteDatabase('str_matcher_db');

// Перезагрузить страницу
location.reload();
```

---

## ⚠️ Важно

### Development vs Production:

| Режим | Поведение | Когда |
|-------|-----------|-------|
| **Development** | База **очищается** при каждой перезагрузке | `npm run dev` |
| **Production** | База **сохраняется** между сессиями | `npm run build` + `npm start` |

### Почему так?

- **Development**: Удобно тестировать с чистой базой
- **Production**: Пользователи не хотят терять данные

---

## 🎯 Итоговое поведение

### ✅ После этого исправления:

1. **Dev режим** (`npm run dev`):
   - Каждая перезагрузка → база пустая ✅
   - Импортируешь CSV → работает ✅
   - F5 → база снова пустая ✅

2. **Production** (`npm run build`):
   - Импортируешь CSV → сохраняется ✅
   - F5 → данные остаются ✅
   - Закрыл браузер → данные остаются ✅

3. **Двойная инициализация**:
   - React Strict Mode → защита работает ✅
   - Логи показываются 1 раз (не 2) ✅

---

**Дата**: Октябрь 2025
**Статус**: ✅ Исправлено
**Файлы**: `str-matcher/src/hooks/useSTRMatcher.ts`
