                                                                                                                                       pg_get_functiondef                                                                                                                                       
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 CREATE OR REPLACE FUNCTION public.find_matches_batch_v5(query_markers jsonb, max_distance integer DEFAULT 25, max_results integer DEFAULT 1000, marker_count integer DEFAULT 37, haplogroup_filter character varying DEFAULT NULL::character varying, include_subclades boolean DEFAULT false)+
  RETURNS TABLE(kit_number character varying, name character varying, country character varying, haplogroup character varying, markers jsonb, genetic_distance integer, compared_markers integer, percent_identical numeric)                                                                   +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                             +
 AS $function$\r                                                                                                                                                                                                                                                                               +
 DECLARE\r                                                                                                                                                                                                                                                                                     +
     panel_markers TEXT[];\r                                                                                                                                                                                                                                                                   +
     query_marker_keys TEXT[];\r                                                                                                                                                                                                                                                               +
     min_required_markers INTEGER;\r                                                                                                                                                                                                                                                           +
     panel_min_threshold INTEGER;\r                                                                                                                                                                                                                                                            +
 BEGIN\r                                                                                                                                                                                                                                                                                       +
     -- Get markers for the selected panel\r                                                                                                                                                                                                                                                   +
     SELECT mp.markers INTO panel_markers\r                                                                                                                                                                                                                                                    +
     FROM marker_panels mp\r                                                                                                                                                                                                                                                                   +
     WHERE mp.panel_size = marker_count;\r                                                                                                                                                                                                                                                     +
 \r                                                                                                                                                                                                                                                                                            +
     -- If panel not found, use default 37\r                                                                                                                                                                                                                                                   +
     IF panel_markers IS NULL THEN\r                                                                                                                                                                                                                                                           +
         SELECT mp.markers INTO panel_markers\r                                                                                                                                                                                                                                                +
         FROM marker_panels mp\r                                                                                                                                                                                                                                                               +
         WHERE mp.panel_size = 37;\r                                                                                                                                                                                                                                                           +
     END IF;\r                                                                                                                                                                                                                                                                                 +
 \r                                                                                                                                                                                                                                                                                            +
     -- Extract query markers that are in the panel AND have values\r                                                                                                                                                                                                                          +
     SELECT ARRAY_AGG(k) INTO query_marker_keys\r                                                                                                                                                                                                                                              +
     FROM unnest(panel_markers) k\r                                                                                                                                                                                                                                                            +
     WHERE query_markers->>k IS NOT NULL\r                                                                                                                                                                                                                                                     +
       AND query_markers->>k != '';\r                                                                                                                                                                                                                                                          +
 \r                                                                                                                                                                                                                                                                                            +
     -- If no valid markers, return empty\r                                                                                                                                                                                                                                                    +
     IF query_marker_keys IS NULL OR array_length(query_marker_keys, 1) IS NULL THEN\r                                                                                                                                                                                                         +
         RETURN;\r                                                                                                                                                                                                                                                                             +
     END IF;\r                                                                                                                                                                                                                                                                                 +
 \r                                                                                                                                                                                                                                                                                            +
     -- Calculate minimum required markers (80% of query markers in panel)\r                                                                                                                                                                                                                   +
     min_required_markers := CEIL(array_length(query_marker_keys, 1) * 0.8);\r                                                                                                                                                                                                                 +
 \r                                                                                                                                                                                                                                                                                            +
     -- Also require profiles to have at least 80% of the panel markers\r                                                                                                                                                                                                                      +
     panel_min_threshold := CEIL(array_length(panel_markers, 1) * 0.8);\r                                                                                                                                                                                                                      +
 \r                                                                                                                                                                                                                                                                                            +
     RETURN QUERY\r                                                                                                                                                                                                                                                                            +
     WITH filtered_profiles AS (\r                                                                                                                                                                                                                                                             +
         SELECT\r                                                                                                                                                                                                                                                                              +
             p.kit_number,\r                                                                                                                                                                                                                                                                   +
             p.name,\r                                                                                                                                                                                                                                                                         +
             p.country,\r                                                                                                                                                                                                                                                                      +
             p.haplogroup,\r                                                                                                                                                                                                                                                                   +
             p.markers,\r                                                                                                                                                                                                                                                                      +
             -- Count how many panel markers this profile has\r                                                                                                                                                                                                                                +
             (\r                                                                                                                                                                                                                                                                               +
                 SELECT COUNT(*)::INTEGER\r                                                                                                                                                                                                                                                    +
                 FROM unnest(panel_markers) pm\r                                                                                                                                                                                                                                               +
                 WHERE p.markers->>pm IS NOT NULL AND p.markers->>pm != ''\r                                                                                                                                                                                                                   +
             ) as profile_panel_marker_count\r                                                                                                                                                                                                                                                 +
         FROM ystr_profiles p\r                                                                                                                                                                                                                                                                +
         WHERE\r                                                                                                                                                                                                                                                                               +
             -- Haplogroup filter\r                                                                                                                                                                                                                                                            +
             (haplogroup_filter IS NULL\r                                                                                                                                                                                                                                                      +
                OR (include_subclades AND p.haplogroup LIKE haplogroup_filter || '%')\r                                                                                                                                                                                                        +
                OR (NOT include_subclades AND p.haplogroup = haplogroup_filter))\r                                                                                                                                                                                                             +
             -- Quick marker overlap check using GIN\r                                                                                                                                                                                                                                         +
             AND p.markers ?& query_marker_keys\r                                                                                                                                                                                                                                              +
         -- Limit early to avoid scanning too many rows\r                                                                                                                                                                                                                                      +
         LIMIT CASE\r                                                                                                                                                                                                                                                                          +
             WHEN haplogroup_filter IS NULL THEN 50000\r                                                                                                                                                                                                                                       +
             ELSE 100000\r                                                                                                                                                                                                                                                                     +
         END\r                                                                                                                                                                                                                                                                                 +
     ),\r                                                                                                                                                                                                                                                                                      +
     distances AS (\r                                                                                                                                                                                                                                                                          +
         SELECT\r                                                                                                                                                                                                                                                                              +
             fp.kit_number,\r                                                                                                                                                                                                                                                                  +
             fp.name,\r                                                                                                                                                                                                                                                                        +
             fp.country,\r                                                                                                                                                                                                                                                                     +
             fp.haplogroup,\r                                                                                                                                                                                                                                                                  +
             fp.markers,\r                                                                                                                                                                                                                                                                     +
             fp.profile_panel_marker_count,\r                                                                                                                                                                                                                                                  +
             -- Calculate genetic distance\r                                                                                                                                                                                                                                                   +
             (\r                                                                                                                                                                                                                                                                               +
                 SELECT SUM(calculate_marker_distance(query_markers->>k, fp.markers->>k))::INTEGER\r                                                                                                                                                                                           +
                 FROM unnest(query_marker_keys) k\r                                                                                                                                                                                                                                            +
                 WHERE fp.markers->>k IS NOT NULL\r                                                                                                                                                                                                                                            +
                   AND fp.markers->>k != ''\r                                                                                                                                                                                                                                                  +
             ) as distance,\r                                                                                                                                                                                                                                                                  +
             -- Count compared markers\r                                                                                                                                                                                                                                                       +
             (\r                                                                                                                                                                                                                                                                               +
                 SELECT COUNT(*)::INTEGER\r                                                                                                                                                                                                                                                    +
                 FROM unnest(query_marker_keys) k\r                                                                                                                                                                                                                                            +
                 WHERE fp.markers->>k IS NOT NULL AND fp.markers->>k != ''\r                                                                                                                                                                                                                   +
             ) as compared,\r                                                                                                                                                                                                                                                                  +
             -- Count identical markers\r                                                                                                                                                                                                                                                      +
             (\r                                                                                                                                                                                                                                                                               +
                 SELECT COUNT(*)::INTEGER\r                                                                                                                                                                                                                                                    +
                 FROM unnest(query_marker_keys) k\r                                                                                                                                                                                                                                            +
                 WHERE fp.markers->>k IS NOT NULL\r                                                                                                                                                                                                                                            +
                   AND fp.markers->>k != ''\r                                                                                                                                                                                                                                                  +
                   AND calculate_marker_distance(query_markers->>k, fp.markers->>k) = 0\r                                                                                                                                                                                                      +
             ) as identical\r                                                                                                                                                                                                                                                                  +
         FROM filtered_profiles fp\r                                                                                                                                                                                                                                                           +
         -- CRITICAL: Only include profiles with enough panel markers (80% of panel)\r                                                                                                                                                                                                         +
         WHERE fp.profile_panel_marker_count >= panel_min_threshold\r                                                                                                                                                                                                                          +
     )\r                                                                                                                                                                                                                                                                                       +
     SELECT\r                                                                                                                                                                                                                                                                                  +
         d.kit_number,\r                                                                                                                                                                                                                                                                       +
         d.name,\r                                                                                                                                                                                                                                                                             +
         d.country,\r                                                                                                                                                                                                                                                                          +
         d.haplogroup,\r                                                                                                                                                                                                                                                                       +
         d.markers,\r                                                                                                                                                                                                                                                                          +
         d.distance,\r                                                                                                                                                                                                                                                                         +
         d.compared,\r                                                                                                                                                                                                                                                                         +
         ROUND((d.identical::NUMERIC / NULLIF(d.compared, 0)::NUMERIC) * 100, 1) as percent_identical\r                                                                                                                                                                                        +
     FROM distances d\r                                                                                                                                                                                                                                                                        +
     WHERE d.distance <= max_distance\r                                                                                                                                                                                                                                                        +
       AND d.compared >= min_required_markers\r                                                                                                                                                                                                                                                +
     ORDER BY d.distance ASC, d.compared DESC, d.kit_number ASC\r                                                                                                                                                                                                                              +
     LIMIT max_results;\r                                                                                                                                                                                                                                                                      +
 END;\r                                                                                                                                                                                                                                                                                        +
 $function$                                                                                                                                                                                                                                                                                    +
 
(1 row)

